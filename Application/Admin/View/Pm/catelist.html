<include file="Public:head"/>

<link rel="stylesheet" href="__JqColor__/css/colpick.css" type="text/css"/>
<!-- 颜色选择器插件 -->
<style>
.btn-success {
	margin-top: 12px;
}
.formitems #addimage1{
    width: 80px;
    height: 56px;
    padding: 0px;
    position: absolute;
    top: 0px;
    left: 0px;
    z-index: 10;
    cursor: pointer;
    opacity: 0;
}
.formitems #addimage2{
    width: 80px;
    height: 56px;
    padding: 0px;
    position: absolute;
    top: 0px;
    left: 0px;
    z-index: 10;
    cursor: pointer;
    opacity: 0;
}

.formitems #editimage1{
    width: 80px;
    height: 56px;
    padding: 0px;
    position: absolute;
    top: 0px;
    left: 0px;
    z-index: 10;
    cursor: pointer;
    opacity: 0;
}

.formitems #editimage2{
    width: 80px;
    height: 56px;
    padding: 0px;
    position: absolute;
    top: 0px;
    left: 0px;
    z-index: 10;
    cursor: pointer;
    opacity: 0;
}
</style>
<div class="container">
<div class="inner clearfix"> <include file="Public:left"/>
  <!-- end content-left -->

  <div class="content-right fl">
    <h1 class="content-right-title">分类列表</h1>
    <!--<div class="alert alert-info disable-del">
      <h4>提示</h4>
      删除分类会删除分类下面所有的产品 <a href="javascript:;" class="alert-delete" title="隐藏"> <i class="gicon-remove"></i></a></div>-->
    <form action="" method="post">
      <div class="clearfix"> <a href="javascript:;" class="btn btn-success fl BtnAddClass">添加分类</a>

      </div>
    </form>
    <table class="wxtables mgt15">
      <colgroup>
      <!--<col width="2%">-->
      <!--<col width="2%">12-->
      <col width="29%">
      <col width="11%">
      <col width="15%">
      <col width="7%">
      <col width="19%">
      <col width="19%">
      </colgroup>
      <thead>
        <tr>
          <!--<td><i class="icon_check"></i></td>-->
          <!--<td>id</td>-->
          <td class="center">分类名称<span style="color:green">(点击一级分类显示二级)</span></td>
          <td class="center">经营保证金</td>
          <td class="center">技术服务费保证金</td>
          <td class="center">排序</td>
          <td class="center">创建时间</td>
          <td class="center">操作</td>
        </tr>
      </thead>
      <tbody>
        <foreach name="cate" item="vo" >
          <tr data-id="{$vo.id}" data-show="0" class="catepid">
            <!--<td class="center"><input type="checkbox" class="checkbox table-ckbs" data-id="9788"></td>-->
            <!--<td>{$vo.id}</td>-->
            <td class="cateone" style="padding-left: 10%">{$vo.classname}</td>
            <td class="cateone center"><notempty name="vo.price">￥{$vo.price}</notempty></td>
            <td class="cateone center"><notempty name="vo.price">￥{$vo.tech_price}</notempty></td>
            <td class="cateone center">{$vo.sort}</td>
            <td class="cateone center">{$vo.create_at|date="Y-m-d H:i:s",###}</td>
            <td class="center"><a href="javascript:void(0);" data-id="{$vo.id}" data-class="{$vo.classname}" data-cate="{$vo.pid}" data-sort="{$vo.sort}" data-title="{$vo.title}" data-img="{$vo.pic}" class="btn btn-primary j-editClass" title="编辑" data-show="{$vo.is_show}" data-tech_price="{$vo.tech_price}" data-price="{$vo.price}">编辑</a>
              <a href="{:U('/Admin/Pm/delCate/id')}/{$vo.id}" class="btn btn-danger j-delClass" title="删除" <eq name="vo.level" value="1">onclick="return confirm('您选择的是顶级分类，如果选择删除，其子分类将全部删除，确定要删除吗？')"<else/>onclick="return confirm('确定要删除吗？')" </eq>data-id="{$vo.id}">删除</a>
              <!-- <a href="javascript:;" class="btn btn-warning j-able" data-able="enable" title="禁用" data-id="9788">禁用</a>
                          -->
            </td>
          </tr>
          <foreach name="vo.two" item="vo1" >
          <tr class="catetwo" data-pid="{$vo.id}" style="display: none">
            <!--<td class="center"><input type="checkbox" class="checkbox table-ckbs" data-id="9788"></td>-->
            <!--<td>{$vo1.id}</td>-->
            <td style="padding-left: 12%">&nbsp;&nbsp;&nbsp;&nbsp;|-{$vo1.classname}</td>
            <td class="center"><notempty name="vo1.pic"><div class="table-item-img"><img src="{$vo1['pic']}" alt=""></div></notempty></td>
            <td class="center"></td>
            <td class="center">{$vo1.sort}</td>
            <td class="center">{$vo1.create_at|date="Y-m-d H:i:s",###}</td>
            <td class="center">
            <a href="javascript:void(0);" class="btn btn-primary j-editClass" title="编辑" data-sort="<?php echo $vo1['sort'];?>"  data-title="{$vo1.title}" data-img="{$vo1.pic}" data-id="{$vo1.id}" data-cate="{$vo1.pid}" data-class="{$vo1.classname}" data-show="{$vo1.is_show}" >编辑</a>
            <a href="{:U('/Admin/Pm/delCate/id')}/{$vo1.id}" class="btn btn-danger j-delClass" title="删除" onclick="return confirm('确定要删除吗？')" data-id="{$vo1.id}">删除</a>
              <!-- <a href="javascript:;" class="btn btn-warning j-able" data-able="enable" title="禁用" data-id="9788">禁用</a>
                          -->
            </td>
          </tr>
          </foreach>
        </foreach>
      </tbody>
    </table>
    <!-- end wxtables -->
    <div class="tables-btmctrl clearfix">
      <div class="fl"> <!--<a href="javascript:;" class="btn btn-primary btn_table_selectAll">全选</a> <a href="javascript:;" class="btn btn-primary btn_table_Cancle">取消</a>-->
        <!--<a href="javascript;" class="btn btn-primary btn_table_delAll">批量删除</a></div>-->
        <div class="fr">
          <!--<div class="paginate">-->

          <div class="pages">
            <!--</div>-->
            {$page}
          </div>
          <!-- end paginate -->
        </div>
      </div>
      <!-- end tables-btmctrl -->
    </div>
    <!-- end content-right -->
  </div>
</div>
</div>
<!-- end container -->
<include file="Public:foot"/>
<div id="albums-overlay" class="disshow"></div>
<div class="jbox addfenlei disshow" style="width: 430px;">
  <div class="jbox-title">
    <div class="jbox-title-txt">添加分类</div>
    <a href="javascript:;" class="jbox-close cancle"></a></div>
  <div class="jbox-container" style="height: 263px;">
    <div class="formitems">
      <label class="fi-name"><span class="colorRed">*</span>分类名称：</label>
      <div class="form-controls">
        <input type="text" class="input classname" maxlength="20" name="classname" >
        <span class="fi-help-text"></span> </div>
    </div>
    <div class="formitems">
      <label class="fi-name"><span class="colorRed"></span>上级分类：</label>
      <div class="form-controls">
      <select name='fid' style='padding:5px;border: 1px solid #ccc;width:182px' id='fid'>
      <option value="0">--顶级分类--</option>
          <foreach name="cate" item="vo" >
            <option value="{$vo.id}">{$vo.classname}</option>
          </foreach>
      </select>
        <span class="fi-help-text"></span> </div>
    </div>
    <input type="hidden" name="id">


    <div class="price" style="display: block">
      <div class="formitems">
        <label class="fi-name"><span class="colorRed">*</span>经营保证金：</label>
        <div class="form-controls">
          <input type="text" class="input price" name="price" maxlength="13" onkeyup="num(this)">
          <span class="fi-help-text"></span> </div>
      </div>
      <div class="formitems">
        <label class="fi-name"><span class="colorRed">*</span>技术服务费保证金：</label>
        <div class="form-controls">
          <input type="text" class="input tech_price" name="tech_price" maxlength="13" onkeyup="num(this)">
          <span class="fi-help-text"></span> </div>
      </div>
    </div>


      <div class="formitems" >
          <label class="fi-name"><span class="colorRed">*</span>是否展示：</label>
          <div class="form-controls">
              <input type="radio" class="input xxlarge" name="is_show" value="1" >是
              <input type="radio" class="input xxlarge" name="is_show" value="0" >否
              <span class="fi-help-text"></span>
          </div>
      </div>

    <div class="formitems">
      <label class="fi-name"><span class="colorRed"></span>分类排序：</label>
      <div class="form-controls">
        <input type="text" class="input" id="addsort" name="sort" onkeyup="(this.v=function(){this.value=this.value.replace(/[^0-9-]+/,'');}).call(this)" onblur="this.v();" />
        <span class="fi-help-text"></span> </div>
    </div>

  </div>
  <div class="jbox-buttons"><a href="javascript:void(0);" class="jbox-buttons-ok btn btn-primary" id="addcategory">确定</a><a
            href="javascript:void (0);" class="jbox-buttons-ok btn cancle">取消</a></div>
</div>


<script type="text/javascript" src="__JS__/jquery-form.js"></script>
<script src="__JqColor__/js/colpick.js" type="text/javascript"></script>

<script type="text/javascript">

  $('.cateone').click(function () {
      var id = $(this).parent().attr('data-id');
      var is_show = $(this).parent().attr('data-show');

      if(is_show==0){
          $(this).parent().attr('data-show',1);
      }else {
          $(this).parent().attr('data-show',0);
      }
      $('.catetwo').each(function () {
          var pid = $(this).attr('data-pid');
         if(is_show==1){
             if(id==pid){
                 $(this).hide();
             }
         }else {
             if(id==pid){
                 $(this).show();
             }else {
                 $('.catepid').each(function () {
                     var data_id = $(this).attr('data-id');
                     if(data_id==pid){
                         $(this).attr('data-show',0);
                     }
                 })
                 $(this).hide();
             }
         }
      })
  })
    $(".cancle").click(function(){
        $(this).parent().parent('.jbox').hide();
        $('#albums-overlay').hide();
    })

  $(function () {
      $('#fid').change(function () {
          var v = $('select[name="fid"]').val();
          if(v==0){
              $('.price').show();
          }else {
              $('.price').hide();
          }
      })
  })
</script>

<!--设置分类-->

<script type="text/javascript">
    $("#addcategory").click(function(){
        var post = {};
        post.classname  = $('.classname').val().trim();
        post.pid        = $('select[name=fid]').val();
        post.sort       = $('input[name=sort]').val().trim();
        post.id         = $('input[name=id]').val();
        post.price      = $("input[name='price']").val();
        post.tech_price      = $("input[name='tech_price']").val();
//        post.type=$('input[name=type]:checked').val();
        //post.title      = $("#title").val();
        post.is_show    = $("input[name=is_show]:checked").val();
        if(!post.classname){
          alert('请填写分类名称！');return false;
        }

        if(post.pid==0){
            if(!post.price){
                alert('请填写经营保证金！');return false;
            }
            if(!post.tech_price){
                alert('请填写技术服务费保证金！');return false;
            }
        }
        $.ajax({
          url:"{:U('Admin/Pm/setCate')}",
          data:{post:post},
          dataType:'json',
          type:'post',
          success:function(data){
            if(data.status == 1){
                alert(data.info);
                window.location.reload();
            } else {
                alert(data.info);
            }
          }
        })
    })

    function num(obj){
        obj.value = obj.value.replace(/[^\d.]/g,""); //清除"数字"和"."以外的字符
        obj.value = obj.value.replace(/^\./g,""); //验证第一个字符是数字
        obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个, 清除多余的
        obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
        obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/,'$1$2.$3'); //只能输入两个小数
    }
</script>
<!--设置分类end-->

<!--添加分类-->

<script type="text/javascript">
    $(".BtnAddClass").click(function(){
        $('input[name=classname]').val('');
        $('input[name=id]').val('');
        $('#title').val('');
        $('input[name="price"]').val('');
        $('input[name="tech_price"]').val('');
        $('select[name=fid] option[value="0"]').attr('selected','selected');
        $('.jbox-title-txt').html('添加分类');
        $('.addfenlei').show();
        $('#albums-overlay').show();
        $(":radio[name='is_show'][value='1']").prop("checked", "checked");
        $(".showimg").empty();
    });

    //最后页数据删除完跳转
    $(function () {
        var oldp = "{$_GET['p']}";
        var p = $('.current').html();
        if (oldp){
            if(p){
                if(oldp!=p){
                    location.href = "{:U('/Admin/Goods/goodscate/p/"+p+"')}";
                }
            }
        }
    })
</script>
<!--添加分类end-->

<!--修改分类-->
<script type="text/javascript">
  var categoryid;
  $(".j-editClass").click(function(){
    var classname = $(this).attr('data-class');
    var id   = $(this).attr('data-id');
    var sort = $(this).attr('data-sort');
    var cate = $(this).attr('data-cate');
    var img  = $(this).attr('data-img');
    var title= $(this).attr('data-title');
    var price=$(this).attr('data-price');
      var tech_price=$(this).attr('data-tech_price');
    var show = $(this).attr("data-show");
    $(":radio[name='is_show'][value='" + show + "']").prop("checked", "checked");
    $('input[name="classname"]').val(classname);
      $('input[name="price"]').val(price);
      $('input[name="tech_price"]').val(tech_price);
    $('input[name="sort"]').val(sort);
    $('input[name="id"]').val(id);
      if(cate==0){
          $('.price').show();
      }else {
          $('.price').hide();
      }
    $('select[name=fid] option[value='+cate+']').attr('selected','selected');
    $('.jbox-title-txt').html('编辑分类');
    $('.addfenlei').show();
    $('#albums-overlay').show();
  });
  </script>
<!--修改分类end-->