<include file="Public:head"/>

<script type="text/javascript" src="__LHG__/lhgcore.min.js"></script>
<script type="text/javascript" src="__LHG__/lhgcalendar.min.js"></script>
<script>
    J(function(){
        J('#birth').calendar({ format:'yyyy-MM-dd'});
        J('#birth1').calendar({ format:'yyyy-MM-dd'});

    });
</script>
<style>
    .imgnav {
        max-height: 30px;
        overflow: hidden;
        cursor: pointer;
    }

    .imgwrapper {
        display: block;
        width: 78px;
        height: 78px;
        overflow: hidden;
    }

    .imgwrapper img {
        display: block;
        width: 100%;
        padding: 0;
        margin: 0;
        border: 0;
    }

    .spanpd10 {
        margin: 10px;
    }

    .wxtables.wxtables-sku.newtable {
        width: 40%;
        margin: 0;
    }

    .img-list li {
        width: 60px;
        height: 60px;
    }

    .cst_h3 span {
        font-weight: normal;
    }

    #imgdiv img {
        max-width: 190px;
        max-height: 190px;
        display: none;
        margin: 5px;
    }

    .btnimage {
        width: 80px;
        height: 30px;
        background: white;
        border: 1px solid #d9d9d9;
        cursor: pointer;
        position: relative;
        text-align: center;
        line-height: 31px;
    }

    .file {
        position: absolute;
        top: 0px;
        left: 0;
        width: 80px;
        height: 30px;
        background: white;
        border: 1px solid #d9d9d9;
        cursor: pointer;
        opacity: 0
    }

    #imgdiv2 img {
        max-width: 88px;
        max-height: 88px;
        display: none;
        margin: 5px;
    }

    #xuanze2 {
        width: 60px;
        height: 30px;
        background: white;
        border: 1px solid #d9d9d9;
    }

    #xuanze2:hover {
        background: #E6E6E6;
    }

    .huase {
        display: none;
        width: 86px;
        height: 30px;
        margin: 5px;
        text-indent: 5px;
    }
    .mar-left {
        margin-left: 130px;
    }
    .fi-zj {
        float: left;
        color: #333;
    }
    .fl_left {
        float: left;
    }
    .mar-top {
        margin-top: 10px;
    }
</style>


<div class="container">
    <div class="inner clearfix">
        <include file="Public:left"/>
        <!-- end content-left -->

        <div class="content-right fl">


            <h1 class="content-right-title">抽奖规则设置</h1>

            <form aciton="" enctype="multipart/form-data" method="post" id="add_step2">
                <div class="panel-single panel-single-light mgt20">
                    <h3 class="cst_h3 mgb20">规则信息</h3>
                    <div>
                        <input type="hidden" class="input" value="{$seckill.id}" name="id">
                        <p id="tianjia" class="btn btn-success max" style="float:right;">增加奖项</p>
                        <p id="jianshao" class="btn btn-success max" style="margin-right:30px;float:right;">减少奖项</p>

                        <div id="jiangxiang">
                            <div class="formitems">
                                <label class="fi-name"><span class="colorRed"></span>
                                    <h1>奖项一：</h1></label>
                                <div class="form-controls">
                                    <div class="radio-group">
                                        <label>
                                            <input type="radio" class="luck_class" name="luck_class[0]" value="1">
                                            赠送积分</label>
                                        <label>
                                            <input type="radio" class="luck_class chanpin" data-k="0" name="luck_class[0]" value="2">
                                            赠送产品</label>
                                    </div>

                                    <div class="formitems choosejifen" style="display:none;">
                                        <label class="fi-name">赠送积分数量：</label>
                                        <div class="form-controls mar-left">
                                            <input type="text" class="input activity_name max" value="" name="integral[0]" onkeyup="num(this)">
                                            <span class="lh30 mgl10"></span>
                                        </div>
                                    </div>
                                    <div class="formitems choosechanpin" id="chanpin0" style="display:none;">
                                        <div><input name="goodsid[0]" id="goodsid0" type="hidden" value=""/><input type="text" id="goodsname0" value="" readonly/><img id="img0" src=""/></div>
                                    </div>
                                    <div class="mar-top">
                                        <label class="fi-name">中奖概率：</label>
                                        <div class="fl_left">
                                            <input type="text" class="input activity_name max" value="" name="probability[0]" onkeyup="num(this)">%
                                            <span class="lh30 mgl10"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="formitems">
                            <label class="fi-name"><span class="colorRed">*</span>大转盘logo图片(小)：</label>
                            <div class="form-controls pdt5 j-imglistPanel">
                                <div class="xuanze_showimge fl mgr10"></div>
                                <div class="btnimage fl">选择图片
                                    <input type="file"  accept="image/jpg,image/jpeg,image/png" name="serial" id="xuanze" class="file" >
                                </div>
                                <div class="xuanze_progress fl mgr15" style="display:none"><img src="__IMAGES__/loadings.gif" width="30" /><span class="xuanze_percent">80%</span></div>
                                <span class="fi-help-text fl lh30 mgl10">建议大小（宽450px高450px）</span>
                            </div>
                        </div>
                        <div class="formitems">
                            <label class="fi-name"><span class="colorRed">*</span>活动标题：</label>
                            <div class="form-controls">
                                <input type="text" class="input title" name="title" value="" />
                                <span class="fi-help-text"></span>
                            </div>
                        </div>
                        <div class="formitems">
                            <label class="fi-name"><span class="colorRed"></span>开始时间：</label>
                            <div class="form-controls">
                                <input type="input" class="select" value="" name="start" id="birth">
                                <span class="lh30 mgl10"></span>
                            </div>
                        </div>
                        <div class="formitems">
                            <label class="fi-name"><span class="colorRed"></span>结束时间：</label>
                            <div class="form-controls">
                                <input type="input" class="select" value="" name="stop" id="birth1">
                                <span class="lh30 mgl10"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel-single panel-single-light mgt20 txtCenter">
                    <a href="javascript:history.back(-1)" class="btn">返回</a>
                    <a href="javascript:;" class="btn btn-primary queren">保存</a>
                    <!--<input type="submit" class="btn btn-primary" value="保存">-->
                </div>
            </form>

        </div>

        <!-- end content-right -->
    </div>
</div>
<!-- end container -->
<include file="Public:foot"/>

<div id="albums-overlay" class="disshow"></div>
<div class="jbox addfenlei disshow" style="width:600px;height:348px;">
    <div class="jbox-title">
        <div class="jbox-title-txt">选择产品</div>
        <a href="javascript:;" class="jbox-close cancle"></a></div>
    <div id="choosegoods" class="panel-single panel-single-light mgt20 j-showinhyd" style="height:200px;overflow-y:scroll; ">
        <h3 class="cst_h3 mgb20">选择产品</h3>
        <input type="hidden" name="k" id="k"/>
        <table class="wxtables mgt15" id="checkgoodsid" style="margin-bottom: 10px;">
            <colgroup>
                <col width="15%">
                <col width="15%">
                <col width="25%">
                <col width="25%">
                <col width="20%">
            </colgroup>
            <thead>
                <tr>
                    <td><i class="icon_check"></i></td>
                    <td>ID</td>
                    <td align="center">图片</td>
                    <td align="center">商品名</td>
                    <td align="center">价格（元）</td>
                </tr>
            </thead>
            <tbody>
            <foreach name="goods_list" item="vo">
                <tr class="xuanze">
                    <td><input type="radio" name="check_goodsid" data-goods_name="{$vo.goods_name}" data-logo_pic="{$vo.logo_pic}" class="checkbox table-ckbs checkids" value="{$vo['id']}"></td>
                    <td>{$vo.id}</td>
                    <td align="center"><img src="{$vo.logo_pic}" width="50" alt=""></td>
                    <td align="center">
                        <p>{$vo.goods_name}</p>
                    </td>
                    <td align="center">¥{$vo.price}</td>
                </tr>
            </foreach>
            </tbody>
        </table>
    </div>
    <div class="jbox-buttons"><a href="javascript:void(0);" class="jbox-buttons-ok btn btn-primary" id="addcategory">确定</a><a
            href="javascript:void (0);" class="jbox-buttons-ok btn cancle">取消</a></div>
</div>

<script>
    xuanze();
    chanpin();
    var a = 0;
    $("#tianjia").click(function () {
        if (a > 4) {
            alert("奖项设置过多！");
            return false;
        }
        a = a + 1;
        var daxie = get_daxie(a);
        var lengh = $("#jiangxiang").children('.formitems').length;
        var htmlstr = '<div class="formitems"><label class="fi-name"><span class="colorRed"></span> <h1>' + daxie + '：</h1></label>' +
                '<div class="form-controls"> <div class="radio-group"> <label><input type="radio" class="luck_class" name="luck_class[' + a + ']" value="1">赠送积分</label>' +
                '<label><input type="radio" class="luck_class chanpin" data-k="' + a + '" name="luck_class[' + a + ']" value="2">赠送产品</label> </div>' +
                '<div class="formitems choosejifen" style="display:none;"> <label class="fi-name">赠送积分数量：</label><div class="form-controls mar-left"> ' +
                '<input type="text" class="input activity_name max" value="" name="integral[' + a + ']" onkeyup="num(this)"> ' +
                '<span class="lh30 mgl10"></span> </div>' +
                ' </div><div class="formitems choosechanpin" id="chanpin' + a + '" style="display:none;">' +
                    '<div><input name="goodsid[' + a + ']" id="goodsid' + a + '" type="hidden" value=""/><input type="text" id="goodsname' + a + '" value="" readonly/><img id="img' + a + '" src=""/></div>' +
                '</div>' +
                '<div class="mar-top">' +
                '<label class="fi-name">中奖概率：</label>' +
                '<div class="fl_left">' +
                '<input type="text" class="input activity_name max" value="" name="probability[' + a + ']" onkeyup="num(this)">%' +
                '<span class="lh30 mgl10"></span></div></div>' +
                '</div></div>';
        if (lengh <= 8) {
            $("#jiangxiang").append(htmlstr);
        }
        xuanze();
        chanpin();
    });

    $("#jianshao").click(function () {
        var lengh = $("#jiangxiang").children('.formitems').length;
        if (lengh > 1) {
            $("#jiangxiang").children('.formitems').last().remove();
            a = a - 1;
        }
    });

    function xuanze() {
        $(".luck_class").change(function () {
            if ($(this).val() == 1) {
                $(this).parents('.formitems').find(".choosejifen").show();
                $(this).parents('.formitems').find(".choosechanpin").find('input').val('');
                $(this).parents('.formitems').find(".choosechanpin").find('img').attr('src', '');
                $(this).parents('.formitems').find(".choosechanpin").hide();
            } else {
                //$("#choosegoods").show();
                $(this).parents('.formitems').find(".choosejifen").hide();
                //$(this).parents('.formitems').find(".choosechanpin").html('');
            }
        });
    }

    function chanpin() {
        $(".chanpin").click(function () {
            var k = $(this).attr('data-k');
            $("#k").val(k);
            $('.addfenlei').show();
            $('#albums-overlay').show();
        })
    }

    $("#addcategory").click(function () {
        var k = $("#k").val();
        var checklen = $(".ischecked").length;
        if (!checklen) {
            alert("请选择抽奖产品");
            return false;
        }
        var pid = $(".ischecked").find('input[name="check_goodsid"]:checked').val();
        var goods_name = $(".ischecked").find('input[name="check_goodsid"]:checked').attr('data-goods_name');
        var logo_pic = $(".ischecked").find('input[name="check_goodsid"]:checked').attr('data-logo_pic');
        //var strr = '<div><input name="goodsid['+k+']" type="hidden" value="'+pid+'"/><input type="text" value="'+goods_name+'" readonly/><img src="'+logo_pic+'"/></div>';
        $("#goodsid" + k).val(pid);
        $("#goodsname" + k).val(goods_name);
        $("#img" + k).attr('src', logo_pic);
        //$("#chanpin"+k).html(strr);
        $("#chanpin" + k).show();
        $(".addfenlei").hide();
        $('#albums-overlay').hide();
    });

    function get_daxie(a) {
        var str;
        switch (a)
        {
            case 1:
                str = "奖项二";
                break;
            case 2:
                str = "奖项三";
                break;
            case 3:
                str = "奖项四";
                break;
            case 4:
                str = "奖项五";
                break;
            case 5:
                str = "奖项六";
                break;
            default:
                str = "奖项";
        }
        return str;
    }

</script>
<script>
    $(".cancle").click(function () {
        $(this).parent().parent('.jbox').hide();
        $('#albums-overlay').hide();
    });
    $(document).on('click', '.queren', function () {
        var post = $("#add_step2").serialize();
        $.ajax({
            url: "{:U('/Admin/Activity/Guize')}",
            type: 'post',
            data: post,
            datatype: 'json',
            success: function (data) {
                //console.log(data);
                if (data.status == 1) {
                    alert(data.info);
                    location.href = "{:U('Admin/Activity/lucklist')}";
                } else {
                    alert(data.info);
                }
            }
        });
    });
</script>
<script type="text/javascript" src="__JS__/jquery-form.js"></script>
<script>
    $(document).on('click', '.checkids', function () {
        if ($(this).parents('.xuanze').hasClass('ischecked')) {
            $(this).parents('.xuanze').removeClass('ischecked');
        } else {
            $(this).parents('.xuanze').addClass('ischecked');
        }
    })

    var percent = $('.xuanze_percent');
    var progress = $('.xuanze_percent');
    $("#xuanze").wrap("<form id='myupload1' action='{:U('/Admin/Index/addImage')}' method='post' enctype='multipart/form-data'></form>");
    $("#xuanze").change(function () { //选择文件
        $("#myupload1").ajaxSubmit({
            dataType: 'json', //数据格式为json
            beforeSend: function () { //开始上传
                progress.show(); //显示进度条
                var percentVal = '0%';
                percent.html(percentVal);
            },
            uploadProgress: function (event, position, total, percentComplete) {
                var percentVal = percentComplete + '%'; //获得进度
                percent.html(percentVal); //显示上传进度百分比
            },
            success: function (data) { //成功
                var img = '<img src="' + data[0]["savepath"].substr(1) + data[0]["savename"] + '" height="80" ><input type="hidden" name="img" id="pic" value="' + data[0]["savepath"].substr(1) + data[0]["savename"] + '"></input>';
                $('.xuanze_showimge').html(img);
                progress.hide();
            },
            error: function (xhr) { //上传失败
                //console.log(xhr.status)
            }
        });
    });
</script>

<script type="text/javascript">

    UE.getEditor('editor', {
        toolbars: [
            ['source', 'fontfamily', 'fontsize', 'bold', 'italic', 'underline', 'forecolor', 'redo', 'undo', 'insertunorderedlist', 'insertorderedlist', 'cleardoc', 'justifyleft', 'justifyright', 'justifycenter', 'justifyjustify', 'insertimage', 'inserttable', 'insertrow', 'insertcol', "mergeright", "mergedown", "deleterow", "deletecol", "splittorows", "splittocols", "splittocells", "deletecaption", 'inserttitle', 'mergecells', 'deletetable', 'cleardoc', 'insertparagraphbeforetable', 'edittable', 'edittd']

        ],
        autoHeightEnabled: false,
        autoFloatEnabled: true,
        elementPathEnabled: false,
        enableContextMenu: false,
        wordCount: false,
    });


</script>
<script>
  function num(obj){
    obj.value = obj.value.replace(/[^\d.]/g,""); //清除"数字"和"."以外的字符
    obj.value = obj.value.replace(/^\./g,""); //验证第一个字符是数字
    obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个, 清除多余的
    obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
    obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/,'$1$2.$3'); //只能输入两个小数
  }
</script>



